

# Schema Design Document

## Overview

The ThoughtJournal application requires three main entities for its functionality:

1. **Supabase Auth Users (`auth.users`)**  
   Managed by Supabase Auth. Stores information about user accounts (email, password, etc.).

2. **Profiles (`public.profiles`)**  
   An extension of user information that includes subscription status.  
   Each profile corresponds to one `auth.users` record via a one-to-one relationship.

3. **Thoughts (`public.thoughts`)**  
   Stores user-submitted thoughts. Each thought references its owner (a user) via `user_id`.

### Namespace and Database
- Supabase by default places the main app schema in the `public` schema.
- Authentication is handled within `auth` schema tables managed by Supabase.
- Application tables (`profiles` and `thoughts`) will be in `public` schema.

---

## Tables

### 1. `auth.users`
**Managed by Supabase Auth.**  
**Purpose:** Stores user authentication data.  
**Note:** We do not alter `auth.users` directly (it’s managed by Supabase). Instead, we reference it in our tables.

**Key Fields:**  
- `id`: `uuid` (Primary key) – Supabase-generated unique ID for each user.
- `email`: `text` (Unique) – User’s login email.
- Additional fields handled by Supabase (password_hash, etc.).

### 2. `public.profiles`
**Purpose:** Stores application-specific user data, linked 1:1 with `auth.users`.

**Columns:**
- `id`: `uuid`  
  - Primary key.  
  - References `auth.users.id`.
- `subscription_active`: `boolean`  
  - Default: `false`.  
  - Indicates if the user is subscribed/paid.  
- `created_at`: `timestamp with time zone`  
  - Default: `now()`.  
  - When the profile was created.
- `updated_at`: `timestamp with time zone`  
  - Default: `now()`.  
  - Automatically updated on profile changes (can be managed via triggers).

**Constraints & Relationships:**
- **Primary Key**: `id`
- **Foreign Key**: `id` references `auth.users(id)`  
  Ensures each profile corresponds exactly to one auth user.
- Unique constraint on `id` (implied by primary key).

**Indexes:**
- `PRIMARY KEY (id)`: For quick lookups by user ID.

### 3. `public.thoughts`
**Purpose:** Stores user-submitted thoughts.

**Columns:**
- `id`: `uuid` (or `bigserial`)  
  - Primary key.  
  - If using `uuid` type, generated by default with `gen_random_uuid()`.
- `user_id`: `uuid`  
  - References `auth.users.id`.  
  - Owner of the thought.
- `content`: `text`  
  - The body of the user’s thought.
- `created_at`: `timestamp with time zone`  
  - Default: `now()`.  
  - Timestamp when the thought was inserted.

**Constraints & Relationships:**
- **Primary Key**: `id`
- **Foreign Key**: `(user_id)` references `auth.users(id)`
- `user_id` must always match an existing user in `auth.users`.

**Indexes:**
- `PRIMARY KEY (id)`: For unique identification of each thought.
- `INDEX ON user_id`: To quickly fetch all thoughts by a particular user.

---

## Example SQL Definitions

**Profiles Table:**

```sql
CREATE TABLE public.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_active boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);
```

*(You may add a trigger or a Supabase function to update `updated_at` on row changes.)*

**Thoughts Table:**

```sql
CREATE TABLE public.thoughts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);
```

*(Requires the `uuid-ossp` or `pgcrypto` extension if using `gen_random_uuid()` for UUID generation.)*

---

## Row-Level Security (RLS)

To ensure users can only read and insert their own thoughts, RLS will be enabled on the `thoughts` table.

1. **Enable RLS:**
   ```sql
   ALTER TABLE public.thoughts ENABLE ROW LEVEL SECURITY;
   ```

2. **RLS Policies:**

   - **Select Policy**: Allow users to select only their own thoughts.
     ```sql
     CREATE POLICY "Select own thoughts" ON public.thoughts
     FOR SELECT USING (auth.uid() = user_id);
     ```

   - **Insert Policy**: Allow users to insert thoughts only for themselves.
     ```sql
     CREATE POLICY "Insert own thoughts" ON public.thoughts
     FOR INSERT WITH CHECK (auth.uid() = user_id);
     ```

*(Supabase’s `auth.uid()` function identifies the currently authenticated user.)*

**Note:** For `profiles`, you may set up RLS if you need to restrict who can view certain profile fields. Typically, the server environment (using the service role key) will handle subscription checks, so RLS may be optional. However, you could enforce that users can only select their own profiles if desired:

```sql
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Select own profile" ON public.profiles
FOR SELECT USING (auth.uid() = id);
```

---

## Data Flow & Usage Notes

- **User Creation**:  
  When a user signs up via Supabase Auth, a record is created in `auth.users`.  
  A corresponding `profiles` row is often created automatically via a Supabase function or your backend logic after sign-up. This ensures that `subscription_active` is initially `false`.

- **Subscription Updates**:  
  When the user successfully pays via Stripe and the webhook fires, the backend updates `profiles.subscription_active = true` for that user’s `id`.

- **Inserting Thoughts**:  
  When a subscribed user adds a new thought:
  - The client sends an authenticated request to a serverless function that uses service role key (or just a regular Supabase client with user’s token) to `INSERT` a row into `public.thoughts`.
  - The `INSERT` respects RLS. Since `auth.uid()` matches `user_id`, the insert is allowed.

- **Selecting Thoughts**:  
  When the client fetches thoughts:
  - A client-side Supabase query `select("*").from("thoughts")` returns only rows where `auth.uid()` = `user_id`, due to RLS.
  - Unauthenticated or unauthorized requests return no rows.

---

## Future Considerations

- Additional columns or tables can be added as the application grows (e.g., `billing_history`, `user_settings`).
- For advanced features (like multiple subscription tiers), you could add more fields to `profiles` or create a `subscriptions` table.

---
